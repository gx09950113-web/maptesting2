<!-- Leaflet æ ¸å¿ƒç¨‹å¼ï¼ˆå¦‚æœä½ é é¢å·²ç¶“æœ‰ï¼Œå°±ä¸ç”¨é‡è¤‡æ”¾ï¼‰ -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- 1) å…ˆåˆå§‹åŒ–åº•åœ–ï¼ˆCRS.Simpleï¼›2048Ã—2048ï¼›map.pngï¼‰ -->
<script>
  // === åŸºæœ¬åœ°åœ–ï¼Œå›ºå®šæœƒæˆåŠŸé¡¯ç¤º ===
  const W = 2048, H = 2048, IMG = 'map.png';

  const map = L.map('map', {
    crs: L.CRS.Simple,
    minZoom: -3,
    wheelPxPerZoomLevel: 80,
    zoomSnap: 0.25
  });

  const sw = L.point(0, H), ne = L.point(W, 0);
  const bounds = L.latLngBounds(map.unproject(sw, 0), map.unproject(ne, 0));
  L.imageOverlay(IMG, bounds).addTo(map);
  map.fitBounds(bounds);

  // åƒç´  <-> LatLng è½‰æ›ï¼ˆCRS.Simpleï¼‰
  const toLatLng = (x, y) => map.unproject(L.point(x, y), 0);
  const toXY     = (latlng) => map.project(latlng, 0);

  // äº’å‹•å±¤ & ç‹€æ…‹
  const markers = new Map();   // docId -> Leaflet Marker
  let selectedId = null;       // ç›®å‰é¸åˆ°çš„æ¨™è¨˜
  let pendingLatLng = null;    // æœ€è¿‘ä¸€æ¬¡é»åœ°åœ–çš„ä½ç½®ï¼ˆå¾…æ–°å¢ï¼‰

  // è‡ªè¨‚å°å·¥å…·åˆ—ï¼ˆå·¦ä¸Šè§’ï¼‰
  const toolbar = L.control({ position: 'topleft' });
  toolbar.onAdd = function() {
    const div = L.DomUtil.create('div', 'leaflet-bar');
    div.innerHTML = `
      <a href="#" id="btnAdd"  title="æ–°å¢æ¨™è¨˜">ï¼‹</a>
      <a href="#" id="btnEdit" title="ç·¨è¼¯æ¨™é¡Œ">âœ</a>
      <a href="#" id="btnDel"  title="åˆªé™¤æ¨™è¨˜">ğŸ—‘</a>
      <a href="#" id="uidTag"  title="ç™»å…¥ç‹€æ…‹" style="pointer-events:none;width:auto;padding:0 6px">æœªç™»å…¥</a>
    `;
    // è®“æ»‘é¼ åœ¨å·¥å…·åˆ—ä¸Šä¸æœƒæ‹–å‹•åœ°åœ–
    L.DomEvent.disableClickPropagation(div);
    return div;
  };
  toolbar.addTo(map);

  // é»åœ°åœ–ï¼šè¨˜ä½åº§æ¨™ï¼ˆç­‰æŒ‰ï¼‹æ‰çœŸçš„å¯«å…¥ï¼‰
  map.on('click', (e) => {
    pendingLatLng = e.latlng;
    L.popup().setLatLng(e.latlng)
      .setContent('å·²é¸åº§æ¨™ï¼šæŒ‰ã€Œï¼‹ã€æ–°å¢æ¨™è¨˜')
      .openOn(map);
  });

  // é€™äº›å‡½å¼æœƒåœ¨ Firebase é‚£æ®µç”¨åˆ°ï¼ˆå…ˆæ›åˆ° window è®“å¾Œé¢å¯ä½¿ç”¨ï¼‰
  window.__leafletCtx = { map, toLatLng, toXY, markers, bounds,
                          getSelectedId: ()=>selectedId,
                          setSelectedId: (id)=>{ selectedId=id; },
                          getPendingLatLng: ()=>pendingLatLng,
                          clearPending: ()=>{ pendingLatLng=null; },
                          setUidText: (t)=>{ const el=document.getElementById('uidTag'); if(el) el.textContent=t; },
                        };
</script>

<!-- 2) Firebaseï¼šå¤šäººå³æ™‚åŒæ­¥ -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  // === ç”¨ä½ çš„å°ˆæ¡ˆå€¼æ›¿æ›é€™æ®µ ===
  const firebaseConfig = {
  apiKey: "AIzaSyC4-eaG7iIA7liOPnw7L2GLZYo9o9JWTiE",
  authDomain: "map-test-202e0.firebaseapp.com",
  projectId: "map-test-202e0",
  storageBucket: "map-test-202e0.appspot.com",
  messagingSenderId: "939257699005",
  appId: "1:939257699005:web:e03994fbd26338c54875d4",
  measurementId: "G-GC2Z2Q8DZE"
};
  // å®‰å…¨ä¿è­·ï¼šå¦‚æœé‚„æ²’æ”¹ configï¼Œå°±å…ˆè·³å‡ºï¼ˆé¿å…æ•´é å ±éŒ¯ï¼‰
  if (firebaseConfig.apiKey.startsWith('__')) {
    alert('è«‹å…ˆåœ¨ index.html ä¸­æ›¿æ› firebaseConfigï¼');
    throw new Error('Firebase config missing');
  }

  // === Firebase åˆå§‹åŒ– & åŒ¿åç™»å…¥ ===
  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  await signInAnonymously(auth).catch((e)=>alert('åŒ¿åç™»å…¥å¤±æ•—ï¼š'+e.message));
  onAuthStateChanged(auth, (user)=>{
    const uidShort = user ? ('UID: ' + user.uid.slice(0,8)) : 'æœªç™»å…¥';
    window.__leafletCtx.setUidText(uidShort);
  });

  // === Firestore å³æ™‚åŒæ­¥ï¼ˆæˆ¿é–“å¯ç”¨ ?room=xxx åˆ‡æ›ï¼‰===
  const urlRoom = new URLSearchParams(location.search).get('room');
  const room = urlRoom || 'default';
  const colRef = collection(db, 'rooms', room, 'markers');

  const { map, toLatLng, toXY, markers, bounds,
          getSelectedId, setSelectedId, getPendingLatLng, clearPending } = window.__leafletCtx;

  // ç›£è½è³‡æ–™è®Šå‹•ï¼šæ–°å¢/æ›´æ–°/åˆªé™¤
  onSnapshot(colRef, (snap)=>{
    const seen = new Set();
    snap.docChanges().forEach((ch)=>{
      const id = ch.doc.id;

      if (ch.type === 'removed') {
        const m = markers.get(id);
        if (m) { m.remove(); markers.delete(id); }
        if (getSelectedId() === id) setSelectedId(null);
        return;
      }

      // æ–°å¢æˆ–æ›´æ–°
      const d = ch.doc.data(); // {x,y,title,color,uid,updatedAt}
      const ll = toLatLng(d.x, d.y);

      if (!markers.has(id)) {
        const m = L.marker(ll, { draggable: true, title: d.title || '' }).addTo(map);
        m.on('click', ()=>{ setSelectedId(id); m.openPopup(); });
        m.on('dragend', async ()=>{
          const xy = toXY(m.getLatLng());
          await setDoc(doc(colRef, id), {
            x: xy.x, y: xy.y, title: d.title || '',
            color: d.color || '#ffcc00', uid: d.uid || '?',
            updatedAt: serverTimestamp(),
          }, { merge: true });
        });
        m.bindPopup(()=>`<b>${d.title||'æœªå‘½å'}</b><br>x=${Math.round(d.x)}, y=${Math.round(d.y)}<br><small>ID:${id}</small>`);
        markers.set(id, m);
      } else {
        const m = markers.get(id);
        m.setLatLng(ll);
        m.options.title = d.title || '';
        m.setPopupContent(`<b>${d.title||'æœªå‘½å'}</b><br>x=${Math.round(d.x)}, y=${Math.round(d.y)}<br><small>ID:${id}</small>`);
      }
      seen.add(id);
    });

    // æ¸…ç†å…¶ä»–ç«¯åˆªæ‰çš„
    for (const [id, m] of markers) {
      if (!seen.has(id)) { m.remove(); markers.delete(id); }
    }
  });

  // === å·¥å…·åˆ—çš„æŒ‰éˆ•äº‹ä»¶ ===
  const byId = (id)=>document.getElementById(id);
  byId('btnAdd') .onclick = async (e)=>{
    e.preventDefault();
    const latlng = getPendingLatLng();
    if (!latlng) { alert('å…ˆåœ¨åœ°åœ–ä¸Šé»ä¸€ä¸‹ï¼Œé¸æ“‡åº§æ¨™ï¼Œå†æŒ‰ï¼‹'); return; }
    const xy = toXY(latlng);
    const title = prompt('æ¨™è¨˜æ¨™é¡Œï¼Ÿ','æ–°æ¨™è¨˜') || 'æ–°æ¨™è¨˜';
    await addDoc(colRef, {
      x: xy.x, y: xy.y, title, color: '#ffcc00',
      uid: (auth.currentUser && auth.currentUser.uid) || '?',
      updatedAt: serverTimestamp(),
    });
    clearPending();
  };

  byId('btnEdit').onclick = async (e)=>{
    e.preventDefault();
    const id = getSelectedId();
    if (!id) { alert('å…ˆé»ä¸€ä¸‹è¦ç·¨è¼¯çš„æ¨™è¨˜'); return; }
    const m = markers.get(id); if (!m) return;
    const cur = m.options.title || '';
    const title = prompt('æ–°çš„æ¨™é¡Œï¼š', cur);
    if (title == null) return;
    const xy = toXY(m.getLatLng());
    await setDoc(doc(colRef, id), { title, x: xy.x, y: xy.y, updatedAt: serverTimestamp() }, { merge: true });
  };

  byId('btnDel') .onclick = async (e)=>{
    e.preventDefault();
    const id = getSelectedId();
    if (!id) { alert('å…ˆé»ä¸€ä¸‹è¦åˆªé™¤çš„æ¨™è¨˜'); return; }
    if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ¨™è¨˜ï¼Ÿ')) return;
    await deleteDoc(doc(colRef, id));
    setSelectedId(null);
  };

  // é€²ä¾†æ™‚å†ä¿éšªä¸€æ¬¡æŠŠåœ–ç½®ä¸­
  map.fitBounds(bounds);
</script>

<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>å¤šäººå³æ™‚äº’å‹•åœ°åœ–</title>

  <!-- âœ… é€™è¡Œæ˜¯ä½ ç¼ºçš„ï¼šLeaflet çš„ CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <!-- âœ… è®“åœ°åœ–å®¹å™¨æœ‰é«˜åº¦ -->
  <style>
    html, body, #map { height: 100%; margin: 0; }
  </style>
</head>
<body>

  <!-- âœ… ä¸€å®šè¦æœ‰é€™å€‹å®¹å™¨ï¼Œid å¿…é ˆå« map -->
  <div id="map"></div>

  <!-- â¬‡ï¸ æŠŠä½ å‰›å‰›è²¼çš„å…©æ®µ <script> åŸå°ä¸å‹•æ”¾åœ¨é€™ä¹‹å¾Œï¼ˆç…§ä½ ç¾åœ¨çš„å…§å®¹å³å¯ï¼‰ -->
  <!-- ä½ çš„ã€ŒLeaflet åˆå§‹åŒ–ã€é‚£æ®µ <script> -->
  <!-- ä½ çš„ã€ŒFirebase æ¨¡çµ„ã€é‚£æ®µ <script type="module"> -->

</body>
</html>

