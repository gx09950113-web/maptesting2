<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¤šäººå³æ™‚äº’å‹•åœ°åœ–</title>

  <!-- Leaflet CSSï¼ˆæ²’æœ‰å®ƒï¼Œåœ°åœ–æœƒçœ‹ä¸åˆ°ï¼‰ -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <!-- è®“åœ°åœ–æœ‰é«˜åº¦ -->
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .topbar{
      position:fixed; left:12px; top:12px; z-index:9999;
      background:rgba(11,18,32,.85); color:#e6eefc;
      padding:10px 12px; border-radius:12px; border:1px solid #223355;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", Arial;
    }
    .topbar button{ margin-right:6px }
    .pill{ display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #2b406a; background:#0e1628; color:#cfe8ff }
    .errorbox{
      position:fixed; right:12px; bottom:12px; z-index:9999;
      max-width:40ch; background:#2b1e1e; color:#ffdede; padding:10px 12px; border:1px solid #5d2b2b; border-radius:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; white-space:pre-wrap;
    }
  </style>
</head>
<body>

  <!-- æ§åˆ¶åˆ—ï¼ˆå…ˆæ”¾è‘—ï¼Œåœ°åœ–æˆåŠŸå¾Œå†ç¶äº‹ä»¶ï¼‰ -->
  <div class="topbar">
    <span class="pill" id="uid">æœªç™»å…¥</span>
    <button id="btnAdd">ï¼‹ åœ¨é»æ“Šè™•æ–°å¢æ¨™è¨˜</button>
    <button id="btnEdit">âœ ç·¨è¼¯é¸å–æ¨™è¨˜</button>
    <button id="btnDel">ğŸ—‘ åˆªé™¤é¸å–æ¨™è¨˜</button>
    <span class="pill">æç¤ºï¼šå–®æ“Šåœ°åœ–â†’å»ºç«‹æš«å­˜åº§æ¨™ï¼Œå†æŒ‰ã€Œï¼‹ã€é€å‡ºï¼›æ‹–æ›³æ¨™è¨˜å³å¯åŒæ­¥ä½ç½®ã€‚</span>
  </div>

  <!-- åœ°åœ–å®¹å™¨ï¼šä¸€å®šè¦å­˜åœ¨ä¸” id="map" -->
  <div id="map"></div>

  <!-- Leaflet JSï¼ˆéæ¨¡çµ„ï¼Œä¿è­‰å…ˆæŠŠåº•åœ–ç•«å‡ºä¾†ï¼‰ -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- 1) åˆå§‹åŒ–åº•åœ–ï¼šé€™æ®µå³ä½¿ Firebase çˆ†éŒ¯ä¹Ÿæœƒæ­£å¸¸ -->
  <script>
    // å…¨åŸŸéŒ¯èª¤æç¤ºï¼ˆä½ çœ‹ä¸åˆ° Console ä¹Ÿèƒ½çŸ¥é“å“ªè£¡éŒ¯ï¼‰
    function showError(msg){
      let box = document.getElementById('err');
      if(!box){ box = document.createElement('div'); box.id='err'; box.className='errorbox'; document.body.appendChild(box); }
      box.textContent = msg;
    }
    window.addEventListener('error', e => showError('JS Error: ' + e.message));
    window.addEventListener('unhandledrejection', e => showError('Promise Error: ' + (e.reason && e.reason.message ? e.reason.message : e.reason)));

    // === åŸºæœ¬åœ°åœ–ï¼Œå›ºå®šæœƒæˆåŠŸé¡¯ç¤º ===
    const W = 2048, H = 2048, IMG = 'map.png';

    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -3,
      wheelPxPerZoomLevel: 80,
      zoomSnap: 0.25
    });

    const sw = L.point(0, H), ne = L.point(W, 0);
    const bounds = L.latLngBounds(map.unproject(sw, 0), map.unproject(ne, 0));
    L.imageOverlay(IMG, bounds).addTo(map);
    map.fitBounds(bounds);

    // åƒç´  <-> LatLngï¼ˆCRS.Simpleï¼‰
    const toLatLng = (x, y) => map.unproject(L.point(x, y), 0);
    const toXY     = (latlng) => map.project(latlng, 0);

    // ç‹€æ…‹
    const markers = new Map();   // docId -> Leaflet Marker
    let selectedId = null;       // ç›®å‰é¸åˆ°çš„æ¨™è¨˜
    let pendingLatLng = null;    // æœ€è¿‘ä¸€æ¬¡é»åœ°åœ–çš„ä½ç½®ï¼ˆå¾…æ–°å¢ï¼‰

    // é»åœ°åœ–ï¼šè¨˜ä½åº§æ¨™ï¼ˆç­‰æŒ‰ï¼‹æ‰çœŸçš„å¯«å…¥ï¼‰
    map.on('click', (e) => {
      pendingLatLng = e.latlng;
      L.popup().setLatLng(e.latlng)
        .setContent('å·²é¸åº§æ¨™ï¼šæŒ‰ã€Œï¼‹ã€æ–°å¢æ¨™è¨˜')
        .openOn(map);
    });

    // è®“ Firebase é‚£æ®µèƒ½æ‹¿åˆ° Leaflet ç’°å¢ƒ
    window.__leafletCtx = {
      map, toLatLng, toXY, markers, bounds,
      getSelectedId: ()=>selectedId,
      setSelectedId: (id)=>{ selectedId=id; },
      getPendingLatLng: ()=>pendingLatLng,
      clearPending: ()=>{ pendingLatLng=null; },
      setUidText: (t)=>{ const el=document.getElementById('uid'); if(el) el.textContent=t; },
    };
  </script>

  <!-- 2) Firebaseï¼šå¤šäººå³æ™‚åŒæ­¥ï¼ˆæ”¾åœ¨å¾Œé¢ï¼›ä¸ç”¨é ‚å±¤ awaitï¼‰ -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // ä½ çš„å°ˆæ¡ˆè¨­å®šï¼ˆæˆ‘å¹«ä½ è£œå›å®˜æ–¹æ ¼å¼çš„ storageBucketï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyC4-eaG7iIA7liOPnw7L2GLZYo9o9JWTiE",
      authDomain: "map-test-202e0.firebaseapp.com",
      projectId: "map-test-202e0",
      storageBucket: "map-test-202e0.appspot.com",
      messagingSenderId: "939257699005",
      appId: "1:939257699005:web:e03994fbd26338c54875d4",
      measurementId: "G-GC2Z2Q8DZE"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // åŒ¿åç™»å…¥ï¼ˆä¸ç”¨é ‚å±¤ awaitï¼Œé¿å…æŸäº›ç’°å¢ƒç›´æ¥ç™½å±ï¼‰
    signInAnonymously(auth)
      .catch((e)=> showError('åŒ¿åç™»å…¥å¤±æ•—ï¼š' + e.message));

    onAuthStateChanged(auth, (user)=>{
      const uidShort = user ? ('UID: ' + user.uid.slice(0,8)) : 'æœªç™»å…¥';
      window.__leafletCtx.setUidText(uidShort);
    });

    // Firestore å³æ™‚åŒæ­¥ï¼ˆå¯ç”¨ ?room=xxx åˆ‡æ›æˆ¿é–“ï¼‰
    const room = new URLSearchParams(location.search).get('room') || 'default';
    const colRef = collection(db, 'rooms', room, 'markers');

    const { map, toLatLng, toXY, markers, bounds,
            getSelectedId, setSelectedId, getPendingLatLng, clearPending } = window.__leafletCtx;

    // ç›£è½è³‡æ–™è®Šå‹•
    onSnapshot(
      colRef,
      (snap)=>{
        const seen = new Set();
        snap.docChanges().forEach((ch)=>{
          const id = ch.doc.id;

          if (ch.type === 'removed') {
            const m = markers.get(id);
            if (m) { m.remove(); markers.delete(id); }
            if (getSelectedId() === id) setSelectedId(null);
            return;
          }

          const d = ch.doc.data(); // {x,y,title,color,uid,updatedAt}
          const ll = toLatLng(d.x, d.y);

          if (!markers.has(id)) {
            const m = L.marker(ll, { draggable: true, title: d.title || '' }).addTo(map);
            m.on('click', ()=>{ setSelectedId(id); m.openPopup(); });
            m.on('dragend', async ()=>{
              const xy = toXY(m.getLatLng());
              try{
                await setDoc(doc(colRef, id), {
                  x: xy.x, y: xy.y, title: d.title || '',
                  color: d.color || '#ffcc00', uid: d.uid || '?',
                  updatedAt: serverTimestamp(),
                }, { merge: true });
              }catch(err){ showError('æ›´æ–°å¤±æ•—ï¼š' + err.message); }
            });
            m.bindPopup(()=>`<b>${d.title||'æœªå‘½å'}</b><br>x=${Math.round(d.x)}, y=${Math.round(d.y)}<br><small>ID:${id}</small>`);
            markers.set(id, m);
          } else {
            const m = markers.get(id);
            m.setLatLng(ll);
            m.options.title = d.title || '';
            m.setPopupContent(`<b>${d.title||'æœªå‘½å'}</b><br>x=${Math.round(d.x)}, y=${Math.round(d.y)}<br><small>ID:${id}</small>`);
          }
          seen.add(id);
        });
        for (const [id, m] of markers) { if (!seen.has(id)) { m.remove(); markers.delete(id); } }
      },
      (err)=> showError('è®€å–å¤±æ•—ï¼š' + err.message + '\nï¼ˆé€šå¸¸æ˜¯ Firestore æœªå»ºç«‹æˆ– Rules é˜»æ“‹ readï¼‰')
    );

    // å·¥å…·åˆ—æŒ‰éˆ•
    const $ = (id)=>document.getElementById(id);
    $('btnAdd').onclick = async (e)=>{
      e.preventDefault();
      const latlng = getPendingLatLng();
      if (!latlng) { alert('å…ˆåœ¨åœ°åœ–ä¸Šé»ä¸€ä¸‹ï¼Œé¸æ“‡åº§æ¨™ï¼Œå†æŒ‰ï¼‹'); return; }
      const xy = toXY(latlng);
      const title = prompt('æ¨™è¨˜æ¨™é¡Œï¼Ÿ','æ–°æ¨™è¨˜') || 'æ–°æ¨™è¨˜';
      try{
        await addDoc(colRef, {
          x: xy.x, y: xy.y, title, color: '#ffcc00',
          uid: (auth.currentUser && auth.currentUser.uid) || '?',
          updatedAt: serverTimestamp(),
        });
        clearPending();
      }catch(err){
        showError('å¯«å…¥å¤±æ•—ï¼š' + err.message + '\n\nå¸¸è¦‹åŸå› ï¼š\n1) æœªç™»å…¥ï¼ˆå·¦ä¸Šä»é¡¯ç¤ºã€Œæœªç™»å…¥ã€ï¼‰\n2) æœªå•Ÿç”¨ Anonymous sign-in\n3) ç¶²åŸŸæœªåŠ å…¥ Authorized domains\n4) Firestore æœªå»ºç«‹æˆ– Rules æœªé–‹æ”¾å¯«å…¥');
      }
    };

    $('btnEdit').onclick = async (e)=>{
      e.preventDefault();
      const id = getSelectedId();
      if (!id) { alert('å…ˆé»ä¸€ä¸‹è¦ç·¨è¼¯çš„æ¨™è¨˜'); return; }
      const m = markers.get(id); if (!m) return;
      const cur = m.options.title || '';
      const title = prompt('æ–°çš„æ¨™é¡Œï¼š', cur);
      if (title == null) return;
      const xy = toXY(m.getLatLng());
      try{
        await setDoc(doc(colRef, id), { title, x: xy.x, y: xy.y, updatedAt: serverTimestamp() }, { merge: true });
      }catch(err){ showError('æ›´æ–°å¤±æ•—ï¼š' + err.message); }
    };

    $('btnDel').onclick = async (e)=>{
      e.preventDefault();
      const id = getSelectedId();
      if (!id) { alert('å…ˆé»ä¸€ä¸‹è¦åˆªé™¤çš„æ¨™è¨˜'); return; }
      if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ¨™è¨˜ï¼Ÿ')) return;
      try{
        await deleteDoc(doc(colRef, id));
        setSelectedId(null);
      }catch(err){ showError('åˆªé™¤å¤±æ•—ï¼š' + err.message); }
    };

    // å†ä¿éšªä¸€æ¬¡æŠŠåœ–ç½®ä¸­
    map.fitBounds(bounds);
  </script>
</body>
</html>
