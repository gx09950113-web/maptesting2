<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>多人即時互動地圖 · GitHub Pages × Leaflet × Firebase</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body,#map{height:100%;margin:0}
    .topbar{position:fixed;left:12px;top:12px;z-index:9999;background:rgba(11,18,32,.85);color:#e6eefc;padding:10px 12px;border-radius:12px;border:1px solid #223355;font-family:ui-sans-serif,system-ui}
    .topbar button{margin-right:6px}
    .pill{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #2b406a;background:#0e1628;color:#cfe8ff}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="topbar">
    <span class="pill" id="uid">未登入</span>
    <button id="add">＋ 在點擊處新增標記</button>
    <button id="edit">✎ 編輯選取標記</button>
    <button id="del">🗑 刪除選取標記</button>
    <span class="pill">提示：單擊地圖→建立暫存座標，再按「＋」送出；拖曳標記即可同步位置。</span>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    // === 1) Firebase 設定（替換下面物件內容） ===
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
  apiKey: "AIzaSyC4-eaG7iIA7liOPnw7L2GLZYo9o9JWTiE",
  authDomain: "map-test-202e0.firebaseapp.com",
  projectId: "map-test-202e0",
  storageBucket: "map-test-202e0.firebasestorage.app",
  messagingSenderId: "939257699005",
  appId: "1:939257699005:web:e03994fbd26338c54875d4",
  measurementId: "G-GC2Z2Q8DZE"
};
      apiKey: "__YOUR_API_KEY__",
      authDomain: "__YOUR_PROJECT_ID__.firebaseapp.com",
      projectId: "__YOUR_PROJECT_ID__",
      storageBucket: "__YOUR_PROJECT_ID__.appspot.com",
      messagingSenderId: "__SENDER_ID__",
      appId: "__APP_ID__"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 匿名登入
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, (user)=>{
      document.getElementById('uid').textContent = user? ('UID: '+user.uid.slice(0,8)) : '未登入';
    });

    // === 2) Leaflet：以 2048×2048 圖片當底圖，使用像素座標 (CRS.Simple) ===
    const imgW = 2048, imgH = 2048; // 你的實際尺寸
    const imageUrl = 'map.png';     // 將你的圖片檔命名為 map.png，放同資料夾

    const map = L.map('map', { crs: L.CRS.Simple, minZoom: -3, wheelPxPerZoomLevel: 80 });
    const southWest = L.point(0, imgH);
    const northEast = L.point(imgW, 0);
    const bounds = L.latLngBounds(map.unproject(southWest, 0), map.unproject(northEast, 0));
    L.imageOverlay(imageUrl, bounds).addTo(map);
    map.fitBounds(bounds);

    // 轉換輔助：像素 <-> Leaflet LatLng（在 CRS.Simple 下）
    const toLatLng = (x, y)=> map.unproject(L.point(x, y), 0); // x=水平(像素), y=垂直(像素)
    const toXY = (latlng)=> map.project(latlng, 0);

    // === 3) Firestore：在特定 room 底下同步標記 ===
    const room = 'default'; // 你可以改成不同場次 ID
    const colRef = collection(db, 'rooms', room, 'markers');

    const markerMap = new Map(); // docId -> Leaflet Marker
    let selectedId = null;

    // 收即時資料
    onSnapshot(colRef, (snap)=>{
      const seen = new Set();
      snap.docChanges().forEach((ch)=>{
        const id = ch.doc.id;
        if (ch.type === 'removed'){
          const m = markerMap.get(id); if(m){ m.remove(); markerMap.delete(id); }
          if(selectedId===id) selectedId = null;
          return;
        }
        const d = ch.doc.data(); // {x,y,title,color,uid}
        const ll = toLatLng(d.x, d.y);
        if (!markerMap.has(id)){
          const m = L.marker(ll, { draggable:true, title: d.title || '' });
          m.addTo(map);
          m.on('click', ()=>{ selectedId = id; m.openPopup(); });
          m.on('dragend', async ()=>{
            const xy = toXY(m.getLatLng());
            await setDoc(doc(colRef, id), { x: xy.x, y: xy.y, title: d.title||'', color: d.color||'#ffcc00', uid: d.uid||'?', updatedAt: serverTimestamp() }, { merge:true });
          });
          m.bindPopup(()=>`<b>${d.title||'未命名'}</b><br>x=${Math.round(d.x)}, y=${Math.round(d.y)}<br><small>ID:${id}</small>`);
          markerMap.set(id, m);
        } else {
          const m = markerMap.get(id);
          // 平滑更新位置/內容
          m.setLatLng(ll);
          m.setPopupContent(`<b>${d.title||'未命名'}</b><br>x=${Math.round(d.x)}, y=${Math.round(d.y)}<br><small>ID:${id}</small>`);
        }
        seen.add(id);
      });
      // 清理不存在的
      for(const [id,m] of markerMap){ if(!seen.has(id)){ m.remove(); markerMap.delete(id); } }
    });

    // === 4) 簡易操作：點擊地圖 → 暫存座標，再按「＋」送出 ===
    let pendingLatLng = null;
    map.on('click', (e)=>{ pendingLatLng = e.latlng; L.popup().setLatLng(e.latlng).setContent('已選擇座標，按「＋」新增標記').openOn(map); });

    document.getElementById('add').onclick = async ()=>{
      if(!pendingLatLng){ alert('請先在地圖上點一點'); return; }
      const xy = toXY(pendingLatLng);
      const title = prompt('標記標題？','新標記') || '新標記';
      await addDoc(colRef, { x: xy.x, y: xy.y, title, color:'#ffcc00', uid: (auth.currentUser && auth.currentUser.uid) || '?', updatedAt: serverTimestamp() });
      pendingLatLng = null;
    };

    document.getElementById('edit').onclick = async ()=>{
      if(!selectedId){ alert('請先點一下要編輯的標記'); return; }
      const m = markerMap.get(selectedId); if(!m) return;
      const curTitle = m.options.title || '';
      const title = prompt('新的標題：', curTitle);
      if(title==null) return;
      const xy = toXY(m.getLatLng());
      await setDoc(doc(colRef, selectedId), { title, x: xy.x, y: xy.y, updatedAt: serverTimestamp() }, { merge:true });
    };

    document.getElementById('del').onclick = async ()=>{
      if(!selectedId){ alert('請先點一下要刪除的標記'); return; }
      if(!confirm('確定刪除此標記？')) return;
      await deleteDoc(doc(colRef, selectedId));
      selectedId = null;
    };

    // === 5)（選用）在頁面載入時居中顯示整張圖 ===
    map.fitBounds(bounds);
  </script>

  <!-- 安全性：請在 Firebase Console 的 Firestore Rules 設定適當規則（見 README/說明）。 -->
</body>
</html>
