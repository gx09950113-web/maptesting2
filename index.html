<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>多人即時互動地圖</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <style>
    html, body, #map { height: 100%; margin: 0; }
    .topbar{
      position:fixed; left:12px; top:12px; z-index:9999;
      background:rgba(11,18,32,.85); color:#e6eefc;
      padding:10px 12px; border-radius:12px; border:1px solid #223355;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", Arial;
    }
    .topbar button{ margin-right:6px }
    .pill{ display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #2b406a; background:#0e1628; color:#cfe8ff }
    .errorbox{
      position:fixed; right:12px; bottom:12px; z-index:9999;
      max-width:40ch; background:#2b1e1e; color:#ffdede; padding:10px 12px; border:1px solid #5d2b2b; border-radius:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; white-space:pre-wrap;
    }
    /* 彩色圓點標記樣式 */
    .u-dot { background: transparent; border: none; }
    .u-dot .dot {
      width: 16px; height: 16px; border-radius: 50%;
      border: 2px solid #fff; box-shadow: 0 0 0 2px rgba(0,0,0,.35);
    }
  </style>
</head>
<body>

  <div class="topbar">
    <span class="pill" id="uid">未登入</span>
    <button id="btnAdd">＋ 在點擊處新增標記</button>
    <button id="btnEdit">✎ 編輯選取標記</button>
    <button id="btnDel">🗑 刪除選取標記</button>
    <span class="pill">提示：單擊地圖→建立暫存座標，再按「＋」送出；拖曳標記即可同步位置。</span>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- 1) Leaflet：一定把底圖畫出來 -->
  <script>
    function showError(msg){
      let box = document.getElementById('err');
      if(!box){ box = document.createElement('div'); box.id='err'; box.className='errorbox'; document.body.appendChild(box); }
      box.textContent = msg;
    }
    window.addEventListener('error', e => showError('JS Error: ' + e.message));
    window.addEventListener('unhandledrejection', e => showError('Promise Error: ' + (e.reason && e.reason.message ? e.reason.message : e.reason)));

    const W = 2048, H = 2048, IMG = 'map.png';
    const map = L.map('map', { crs: L.CRS.Simple, minZoom: -3, wheelPxPerZoomLevel: 80, zoomSnap: 0.25 });
    const sw = L.point(0, H), ne = L.point(W, 0);
    const bounds = L.latLngBounds(map.unproject(sw, 0), map.unproject(ne, 0));
    L.imageOverlay(IMG, bounds).addTo(map);
    map.fitBounds(bounds);

    const toLatLng = (x, y) => map.unproject(L.point(x, y), 0);
    const toXY     = (latlng) => map.project(latlng, 0);

    const markers = new Map();
    let selectedId = null;
    let pendingLatLng = null;

    map.on('click', (e) => {
      pendingLatLng = e.latlng;
      L.popup().setLatLng(e.latlng).setContent('已選座標：按「＋」新增標記').openOn(map);
    });

    window.__leafletCtx = {
      map, toLatLng, toXY, markers, bounds,
      getSelectedId: ()=>selectedId,
      setSelectedId: (id)=>{ selectedId=id; },
      getPendingLatLng: ()=>pendingLatLng,
      clearPending: ()=>{ pendingLatLng=null; },
      setUidText: (t)=>{ const el=document.getElementById('uid'); if(el) el.textContent=t; },
    };
  </script>

  <!-- 2) Firebase：多人即時同步 + 每人顏色 -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyC4-eaG7iIA7liOPnw7L2GLZYo9o9JWTiE",
      authDomain: "map-test-202e0.firebaseapp.com",
      projectId: "map-test-202e0",
      storageBucket: "map-test-202e0.appspot.com",
      messagingSenderId: "939257699005",
      appId: "1:939257699005:web:e03994fbd26338c54875d4",
      measurementId: "G-GC2Z2Q8DZE"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // 使用者顏色（UID -> 色票，可自行改色）
    const PALETTE = ['#ef4444','#f97316','#f59e0b','#84cc16','#22c55e','#10b981','#06b6d4','#0ea5e9','#3b82f6','#6366f1','#a855f7','#ec4899','#14b8a6','#8b5cf6','#eab308','#fb7185'];
    const hash = (s)=>{ let h=0; for(let i=0;i<s.length;i++){ h=(h*31 + s.charCodeAt(i))|0; } return Math.abs(h); };
    let userColor = '#ffcc00';

    const topbar = document.querySelector('.topbar');
    const colorWrap = document.createElement('span');
    colorWrap.style.marginLeft = '8px';
    colorWrap.innerHTML = `<span class="pill" style="margin-right:6px">我的顏色</span><input id="myColor" type="color" value="#ffcc00" title="我的標記顏色">`;
    topbar.appendChild(colorWrap);
    const colorInput = document.getElementById('myColor');

    const iconFor = (color)=> L.divIcon({
      className: 'u-dot',
      html: `<div class="dot" style="background:${color}"></div>`,
      iconSize: [18,18],
      iconAnchor: [9,9]
    });

    signInAnonymously(auth).catch((e)=> showError('匿名登入失敗：' + e.message));
    onAuthStateChanged(auth, (user)=>{
      const uidShort = user ? ('UID: ' + user.uid.slice(0,8)) : '未登入';
      window.__leafletCtx.setUidText(uidShort);
      if (user) {
        const saved = localStorage.getItem('myColor');
        userColor = saved || PALETTE[ hash(user.uid) % PALETTE.length ];
        colorInput.value = userColor;
      }
    });

    colorInput.addEventListener('input', ()=>{
      userColor = colorInput.value;
      localStorage.setItem('myColor', userColor);
    });

    const room = new URLSearchParams(location.search).get('room') || 'default';
    const colRef = collection(db, 'rooms', room, 'markers');

    const { map, toLatLng, toXY, markers, bounds,
            getSelectedId, setSelectedId, getPendingLatLng, clearPending } = window.__leafletCtx;

    // 單一版 onSnapshot（含彩色 icon、拖曳只更新座標）
    onSnapshot(
      colRef,
      (snap)=>{
        const seen = new Set();
        snap.docChanges().forEach((ch)=>{
          const id = ch.doc.id;

          if (ch.type === 'removed') {
            const m = markers.get(id);
            if (m) { m.remove(); markers.delete(id); }
            if (getSelectedId() === id) setSelectedId(null);
            return;
          }

          const d = ch.doc.data();     // {x,y,title,color,uid,updatedAt}
          const ll  = toLatLng(d.x, d.y);
          const col = d.color || '#ffcc00';

          if (!markers.has(id)) {
            const m = L.marker(ll, { draggable: true, title: d.title || '', icon: iconFor(col) }).addTo(map);
            m.on('click', ()=>{ setSelectedId(id); m.openPopup(); });
            m.on('dragend', async ()=>{
              const xy = toXY(m.getLatLng());
              try {
                await setDoc(doc(colRef, id), { x: xy.x, y: xy.y, updatedAt: serverTimestamp() }, { merge: true });
              } catch (err) { showError('更新失敗：' + err.message); }
            });
            m.bindPopup(()=>`<b>${d.title||'未命名'}</b><br>x=${Math.round(d.x)}, y=${Math.round(d.y)}<br><small>ID:${id}</small>`);
            markers.set(id, m);
          } else {
            const m = markers.get(id);
            m.setLatLng(ll);
            m.setIcon(iconFor(col));
            m.options.title = d.title || '';
            m.setPopupContent(`<b>${d.title||'未命名'}</b><br>x=${Math.round(d.x)}, y=${Math.round(d.y)}<br><small>ID:${id}</small>`);
          }
          seen.add(id);
        });
        for (const [id, m] of markers) {
          if (!seen.has(id)) { m.remove(); markers.delete(id); }
        }
      },
      (err)=> showError('讀取失敗：' + err.message + '\n（通常是 Firestore 未建立或 Rules 阻擋 read）')
    );

    const $ = (id)=>document.getElementById(id);
    $('btnAdd').onclick = async (e)=>{
      e.preventDefault();
      const latlng = getPendingLatLng();
      if (!latlng) { alert('先在地圖上點一下，選擇座標，再按＋'); return; }
      const xy = toXY(latlng);
      const title = prompt('標記標題？','新標記') || '新標記';
      try{
        await addDoc(colRef, {
          x: xy.x, y: xy.y, title,
          color: userColor,
          uid: (auth.currentUser && auth.currentUser.uid) || '?',
          updatedAt: serverTimestamp(),
        });
        clearPending();
      }catch(err){ showError('寫入失敗：' + err.message); }
    };

    $('btnEdit').onclick = async (e)=>{
      e.preventDefault();
      const id = getSelectedId();
      if (!id) { alert('先點一下要編輯的標記'); return; }
      const m = markers.get(id); if (!m) return;
      const cur = m.options.title || '';
      const title = prompt('新的標題：', cur);
      if (title == null) return;
      const xy = toXY(m.getLatLng());
      try{
        await setDoc(doc(colRef, id), { title, x: xy.x, y: xy.y, updatedAt: serverTimestamp() }, { merge: true });
      }catch(err){ showError('更新失敗：' + err.message); }
    };

    $('btnDel').onclick = async (e)=>{
      e.preventDefault();
      const id = getSelectedId();
      if (!id) { alert('先點一下要刪除的標記'); return; }
      if (!confirm('確定刪除此標記？')) return;
      try{
        await deleteDoc(doc(colRef, id));
        setSelectedId(null);
      }catch(err){ showError('刪除失敗：' + err.message); }
    };

    map.fitBounds(bounds);
  </script>
</body>
</html>
