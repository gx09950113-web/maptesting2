<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¤šäººå³æ™‚äº’å‹•åœ°åœ– Â· GitHub Pages Ã— Leaflet Ã— Firebase</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body,#map{height:100%;margin:0}
    .topbar{position:fixed;left:12px;top:12px;z-index:9999;background:rgba(11,18,32,.85);color:#e6eefc;padding:10px 12px;border-radius:12px;border:1px solid #223355;font-family:ui-sans-serif,system-ui}
    .topbar button{margin-right:6px}
    .pill{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #2b406a;background:#0e1628;color:#cfe8ff}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="topbar">
    <span class="pill" id="uid">æœªç™»å…¥</span>
    <button id="add">ï¼‹ åœ¨é»æ“Šè™•æ–°å¢æ¨™è¨˜</button>
    <button id="edit">âœ ç·¨è¼¯é¸å–æ¨™è¨˜</button>
    <button id="del">ğŸ—‘ åˆªé™¤é¸å–æ¨™è¨˜</button>
    <span class="pill">æç¤ºï¼šå–®æ“Šåœ°åœ–â†’å»ºç«‹æš«å­˜åº§æ¨™ï¼Œå†æŒ‰ã€Œï¼‹ã€é€å‡ºï¼›æ‹–æ›³æ¨™è¨˜å³å¯åŒæ­¥ä½ç½®ã€‚</span>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    // === 1) Firebase è¨­å®šï¼ˆæ›¿æ›ä¸‹é¢ç‰©ä»¶å…§å®¹ï¼‰ ===
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
  apiKey: "AIzaSyC4-eaG7iIA7liOPnw7L2GLZYo9o9JWTiE",
  authDomain: "map-test-202e0.firebaseapp.com",
  projectId: "map-test-202e0",
  storageBucket: "map-test-202e0.firebasestorage.app",
  messagingSenderId: "939257699005",
  appId: "1:939257699005:web:e03994fbd26338c54875d4",
  measurementId: "G-GC2Z2Q8DZE"
};
      apiKey: "__YOUR_API_KEY__",
      authDomain: "__YOUR_PROJECT_ID__.firebaseapp.com",
      projectId: "__YOUR_PROJECT_ID__",
      storageBucket: "__YOUR_PROJECT_ID__.appspot.com",
      messagingSenderId: "__SENDER_ID__",
      appId: "__APP_ID__"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // åŒ¿åç™»å…¥
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, (user)=>{
      document.getElementById('uid').textContent = user? ('UID: '+user.uid.slice(0,8)) : 'æœªç™»å…¥';
    });

    // === 2) Leafletï¼šä»¥ 2048Ã—2048 åœ–ç‰‡ç•¶åº•åœ–ï¼Œä½¿ç”¨åƒç´ åº§æ¨™ (CRS.Simple) ===
    const imgW = 2048, imgH = 2048; // ä½ çš„å¯¦éš›å°ºå¯¸
    const imageUrl = 'map.png';     // å°‡ä½ çš„åœ–ç‰‡æª”å‘½åç‚º map.pngï¼Œæ”¾åŒè³‡æ–™å¤¾

    const map = L.map('map', { crs: L.CRS.Simple, minZoom: -3, wheelPxPerZoomLevel: 80 });
    const southWest = L.point(0, imgH);
    const northEast = L.point(imgW, 0);
    const bounds = L.latLngBounds(map.unproject(southWest, 0), map.unproject(northEast, 0));
    L.imageOverlay(imageUrl, bounds).addTo(map);
    map.fitBounds(bounds);

    // è½‰æ›è¼”åŠ©ï¼šåƒç´  <-> Leaflet LatLngï¼ˆåœ¨ CRS.Simple ä¸‹ï¼‰
    const toLatLng = (x, y)=> map.unproject(L.point(x, y), 0); // x=æ°´å¹³(åƒç´ ), y=å‚ç›´(åƒç´ )
    const toXY = (latlng)=> map.project(latlng, 0);

    // === 3) Firestoreï¼šåœ¨ç‰¹å®š room åº•ä¸‹åŒæ­¥æ¨™è¨˜ ===
    const room = 'default'; // ä½ å¯ä»¥æ”¹æˆä¸åŒå ´æ¬¡ ID
    const colRef = collection(db, 'rooms', room, 'markers');

    const markerMap = new Map(); // docId -> Leaflet Marker
    let selectedId = null;

    // æ”¶å³æ™‚è³‡æ–™
    onSnapshot(colRef, (snap)=>{
      const seen = new Set();
      snap.docChanges().forEach((ch)=>{
        const id = ch.doc.id;
        if (ch.type === 'removed'){
          const m = markerMap.get(id); if(m){ m.remove(); markerMap.delete(id); }
          if(selectedId===id) selectedId = null;
          return;
        }
        const d = ch.doc.data(); // {x,y,title,color,uid}
        const ll = toLatLng(d.x, d.y);
        if (!markerMap.has(id)){
          const m = L.marker(ll, { draggable:true, title: d.title || '' });
          m.addTo(map);
          m.on('click', ()=>{ selectedId = id; m.openPopup(); });
          m.on('dragend', async ()=>{
            const xy = toXY(m.getLatLng());
            await setDoc(doc(colRef, id), { x: xy.x, y: xy.y, title: d.title||'', color: d.color||'#ffcc00', uid: d.uid||'?', updatedAt: serverTimestamp() }, { merge:true });
          });
          m.bindPopup(()=>`<b>${d.title||'æœªå‘½å'}</b><br>x=${Math.round(d.x)}, y=${Math.round(d.y)}<br><small>ID:${id}</small>`);
          markerMap.set(id, m);
        } else {
          const m = markerMap.get(id);
          // å¹³æ»‘æ›´æ–°ä½ç½®/å…§å®¹
          m.setLatLng(ll);
          m.setPopupContent(`<b>${d.title||'æœªå‘½å'}</b><br>x=${Math.round(d.x)}, y=${Math.round(d.y)}<br><small>ID:${id}</small>`);
        }
        seen.add(id);
      });
      // æ¸…ç†ä¸å­˜åœ¨çš„
      for(const [id,m] of markerMap){ if(!seen.has(id)){ m.remove(); markerMap.delete(id); } }
    });

    // === 4) ç°¡æ˜“æ“ä½œï¼šé»æ“Šåœ°åœ– â†’ æš«å­˜åº§æ¨™ï¼Œå†æŒ‰ã€Œï¼‹ã€é€å‡º ===
    let pendingLatLng = null;
    map.on('click', (e)=>{ pendingLatLng = e.latlng; L.popup().setLatLng(e.latlng).setContent('å·²é¸æ“‡åº§æ¨™ï¼ŒæŒ‰ã€Œï¼‹ã€æ–°å¢æ¨™è¨˜').openOn(map); });

    document.getElementById('add').onclick = async ()=>{
      if(!pendingLatLng){ alert('è«‹å…ˆåœ¨åœ°åœ–ä¸Šé»ä¸€é»'); return; }
      const xy = toXY(pendingLatLng);
      const title = prompt('æ¨™è¨˜æ¨™é¡Œï¼Ÿ','æ–°æ¨™è¨˜') || 'æ–°æ¨™è¨˜';
      await addDoc(colRef, { x: xy.x, y: xy.y, title, color:'#ffcc00', uid: (auth.currentUser && auth.currentUser.uid) || '?', updatedAt: serverTimestamp() });
      pendingLatLng = null;
    };

    document.getElementById('edit').onclick = async ()=>{
      if(!selectedId){ alert('è«‹å…ˆé»ä¸€ä¸‹è¦ç·¨è¼¯çš„æ¨™è¨˜'); return; }
      const m = markerMap.get(selectedId); if(!m) return;
      const curTitle = m.options.title || '';
      const title = prompt('æ–°çš„æ¨™é¡Œï¼š', curTitle);
      if(title==null) return;
      const xy = toXY(m.getLatLng());
      await setDoc(doc(colRef, selectedId), { title, x: xy.x, y: xy.y, updatedAt: serverTimestamp() }, { merge:true });
    };

    document.getElementById('del').onclick = async ()=>{
      if(!selectedId){ alert('è«‹å…ˆé»ä¸€ä¸‹è¦åˆªé™¤çš„æ¨™è¨˜'); return; }
      if(!confirm('ç¢ºå®šåˆªé™¤æ­¤æ¨™è¨˜ï¼Ÿ')) return;
      await deleteDoc(doc(colRef, selectedId));
      selectedId = null;
    };

    // === 5)ï¼ˆé¸ç”¨ï¼‰åœ¨é é¢è¼‰å…¥æ™‚å±…ä¸­é¡¯ç¤ºæ•´å¼µåœ– ===
    map.fitBounds(bounds);
  </script>

  <!-- å®‰å…¨æ€§ï¼šè«‹åœ¨ Firebase Console çš„ Firestore Rules è¨­å®šé©ç•¶è¦å‰‡ï¼ˆè¦‹ README/èªªæ˜ï¼‰ã€‚ -->
</body>
</html>
